<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Points Tracker</title>

  <!-- PWA settings -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#10b981" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Avoid flash -->
  <style>html{background:#101827}</style>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Internal Styles -->
  <style>
    @keyframes press {0%{transform:scale(1)}50%{transform:scale(.96)}100%{transform:scale(1)}}
    .btn-press {animation:press .15s ease-out forwards;}
    .prog {position:absolute;inset:0;width:0%;background:#10b98133;border-radius:0.75rem;}
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

<header class="p-4 bg-gray-800 shadow flex justify-between items-center">
  <div class="text-lg font-bold">Score du jourÂ : <span id="dailyScore" class="text-emerald-400">0</span></div>
  <div class="flex items-center gap-2">
    <span id="todayLabel" class="text-sm text-gray-400"></span>
    <button id="resetBtn" class="px-3 py-1 rounded-lg bg-red-600 text-xs hover:bg-red-500">ResetÂ ðŸ”„</button>
  </div>
</header>

<nav class="flex justify-center gap-4 my-3">
  <button id="tabTasks" class="px-4 py-2 rounded-lg bg-emerald-600 font-semibold">TÃ¢ches</button>
  <button id="tabStats" class="px-4 py-2 rounded-lg bg-gray-700 font-semibold">Statistiques</button>
</nav>

<main id="mainContent" class="flex-1 overflow-y-auto p-4"></main>
<footer class="text-center text-xs text-gray-500 py-2">Â©Â 2025Â â€“ LibertÃ©Â !</footer>

<div id="toast" class="hidden fixed bottom-4 inset-x-0 flex justify-center pointer-events-none">
  <span id="toastMsg" class="px-4 py-2 rounded-lg bg-gray-800 text-sm shadow-lg opacity-0 transition-opacity duration-300"></span>
</div>
<audio id="tapSnd" src="tap-soft.mp3" preload="auto"></audio>

<!-- Firebase & Chart.js -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<script defer>
  // Default tasks seeding
  const DEFAULT_TASKS = [
    { id: 1, name: "Boire un verre d'eau", pts: 1, goal: 6 },
    { id: 2, name: "Ã‰tirements matinaux", pts: 2, goal: 4 },
    { id: 3, name: "MÃ©ditationÂ 5Â min", pts: 3, goal: 2 },
    { id: 4, name: "MarcheÂ 10Â min", pts: 2, goal: 3 },
    { id: 5, name: "LectureÂ 10Â pages", pts: 4, goal: 1 }
  ];

  // Helpers
  const LS = 'dpt-db';
  const today = () => new Date().toISOString().slice(0,10);
  const load = () => JSON.parse(localStorage.getItem(LS)||'{}');
  const save = d => localStorage.setItem(LS, JSON.stringify(d));
  const norm = o => { for (const k in o) if (typeof o[k] === 'number') o[k] = { total: o[k], counts: {} }; return o; };

  // State
  let data = norm(load());
  let chart = null, curTab = 'tasks', range = '7';
  let remoteDoc = null, tasksDoc = null, tasks = [];

  // UI refs
  const scoreEl = document.getElementById('dailyScore'),
        labelEl = document.getElementById('todayLabel'),
        mainEl  = document.getElementById('mainContent'),
        tabTasks = document.getElementById('tabTasks'),
        tabStats = document.getElementById('tabStats'),
        resetBtn = document.getElementById('resetBtn');

  function toast(msg){
    const wrap = document.getElementById('toast'), box = document.getElementById('toastMsg');
    box.textContent = msg; wrap.classList.remove('hidden');
    requestAnimationFrame(()=>box.classList.remove('opacity-0'));
    setTimeout(()=>{ box.classList.add('opacity-0'); setTimeout(()=>wrap.classList.add('hidden'),300); }, 1200);
  }
  const flash = b => { b.classList.add('btn-press'); setTimeout(()=>b.classList.remove('btn-press'),150); };

  function ensureToday(){
    if (!data[today()]) { data[today()] = { total: 0, counts: {} }; save(data); }
  }

  function setTab(t){
    curTab = t;
    tabTasks.className = `px-4 py-2 rounded-lg font-semibold ${t==='tasks'?'bg-emerald-600':'bg-gray-700'}`;
    tabStats.className = `px-4 py-2 rounded-lg font-semibold ${t==='stats'?'bg-emerald-600':'bg-gray-700'}`;
  }

  function renderTasks(){
    ensureToday();
    setTab('tasks');
    const d = today();
    scoreEl.textContent = data[d].total;
    labelEl.textContent = new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'short'});
    mainEl.innerHTML = '';
    const counts = data[d].counts||{};
    tasks.forEach(t => {
      const done = counts[t.id]||0, pct = Math.min(done/t.goal,1)*100;
      const btn = document.createElement('button');
      btn.className = 'relative w-full mb-3 px-4 py-3 rounded-xl bg-gray-800 active:bg-emerald-700 transition duration-150 shadow overflow-hidden';
      btn.innerHTML = `
        <div class="prog" style="width:${pct}%"></div>
        <div class="relative z-10 flex justify-between items-center">
          <span>${t.name}</span><span class="font-semibold">+${t.pts}</span>
        </div>
        <div class="relative z-10 text-xs text-gray-400 flex justify-end mt-1">
          <span data-c="${t.id}">${done}</span>/<span>${t.goal}</span>
        </div>`;
      btn.onclick = () => {
        ensureToday();
        data[d].total += t.pts;
        data[d].counts[t.id] = (data[d].counts[t.id]||0)+1;
        save(data);
        remoteDoc && remoteDoc.set(data);
        toast(`+${t.pts} pts âœ…`); flash(btn);
        const done2 = data[d].counts[t.id];
        btn.querySelector(`[data-c="${t.id}"]`).textContent = done2;
        btn.querySelector('.prog').style.width = Math.min(done2/t.goal,1)*100 + '%';
      };
      mainEl.appendChild(btn);
    });
  }

  function renderStats(){ /* ... your existing stats code ... */ }

  // Firebase init & seeding
  window.addEventListener('load', () => {
    firebase.initializeApp({
      apiKey: "AIzaSyCssm-z4wtOWcK1qvbJc2SIQ6Pvc3JEszY",
      authDomain: "health-fdf5b.firebaseapp.com",
      projectId: "health-fdf5b"
    });
    const auth = firebase.auth(), db = firebase.firestore();
    auth.signInAnonymously().then(() => {
      remoteDoc = db.collection('users').doc('global');
      tasksDoc  = db.collection('config').doc('tasks');

      // Load or seed tasks list
      tasksDoc.get().then(snap => {
        if (snap.exists) {
          tasks = snap.data().list || [];
        } else {
          tasks = DEFAULT_TASKS;
          tasksDoc.set({ list: DEFAULT_TASKS });
        }
        renderTasks();
      });

      // Listen for remote changes
      remoteDoc.get().then(snap => {
        if (snap.exists) { data = norm(snap.data()); save(data); }
        renderTasks();
      });
      remoteDoc.onSnapshot(snap => {
        if (snap.exists) { data = norm(snap.data()); save(data); if(curTab==='tasks') renderTasks(); }
      });

    });

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js');
    }
  });
</script>
</body>
</html>
