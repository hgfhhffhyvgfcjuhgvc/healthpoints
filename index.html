<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Points Tracker</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <link rel="manifest" href="manifest.webmanifest" />
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
  <header class="p-4 bg-gray-800 shadow flex justify-between items-center">
    <h1 class="text-lg font-bold">Score du jour : <span id="dailyScore" class="text-emerald-400">0</span></h1>
    <span id="todayLabel" class="text-sm text-gray-400"></span>
  </header>

  <nav class="flex justify-center gap-4 my-3">
    <button id="tabTasks" class="px-4 py-2 rounded-lg bg-emerald-600 font-semibold">Tâches</button>
    <button id="tabStats" class="px-4 py-2 rounded-lg bg-gray-700 font-semibold">Statistiques</button>
  </nav>

  <main id="mainContent" class="flex-1 overflow-y-auto p-4"></main>
  <footer class="text-center text-xs text-gray-500 py-2">© 2025 – Liberté & motivations !</footer>

<script>
/***** 1. Firebase init *****/
const firebaseConfig = {
  apiKey: "AIzaSyCssm-z4wtOWcK1qvbJc2SIQ6Pvc3JEszY",
  authDomain: "health-fdf5b.firebaseapp.com",
  projectId: "health-fdf5b",
  storageBucket: "health-fdf5b.appspot.com",
  messagingSenderId: "304202917649",
  appId: "1:304202917649:web:23d6ead24ddb2033378eb0"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
let remoteDocRef, uid;

/***** 2. Local storage helpers *****/
const LS_KEY = 'dpt-db';
const todayStr = () => new Date().toISOString().slice(0,10);
const loadData = () => JSON.parse(localStorage.getItem(LS_KEY)||'{}');
const saveData = d => localStorage.setItem(LS_KEY, JSON.stringify(d));
const getDayTotal = d => loadData()[d] || 0;

/***** 3. Tasks *****/
const TASKS = [
  {id:1,name:"Boire un verre d'eau",pts:1},
  {id:2,name:"Étirements matinaux",pts:2},
  {id:3,name:"Méditation 5 min",pts:3},
  {id:4,name:"Marche 10 min",pts:2},
  {id:5,name:"Lecture 10 pages",pts:4}
];

/***** 4. UI refs *****/
const scoreEl=document.getElementById('dailyScore');
const labelEl=document.getElementById('todayLabel');
const main   =document.getElementById('mainContent');
let chartInstance=null,currentTab='tasks',currentRange='7';

/***** 5. Rendering functions *****/
function setActive(tab){
  currentTab=tab;
  tab==='tasks' ? (tabTasks.classList.replace('bg-gray-700','bg-emerald-600'), tabStats.classList.replace('bg-emerald-600','bg-gray-700'))
                : (tabStats.classList.replace('bg-gray-700','bg-emerald-600'), tabTasks.classList.replace('bg-emerald-600','bg-gray-700'));
}
function renderTasks(){
  setActive('tasks');
  const today=todayStr();
  scoreEl.textContent=getDayTotal(today);
  labelEl.textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'short'});
  main.innerHTML='';
  TASKS.forEach(t=>{
    const btn=document.createElement('button');
    btn.className='w-full mb-3 px-4 py-3 rounded-xl bg-gray-800 hover:bg-emerald-700 shadow';
    btn.innerHTML=`${t.name}<span class='float-right font-semibold'>+${t.pts}</span>`;
    btn.onclick=()=>{addPoints(today,t.pts);scoreEl.textContent=getDayTotal(today);} ;
    main.appendChild(btn);
  });
}
function renderStats(){
  setActive('stats');
  labelEl.textContent='';
  main.innerHTML=`<div class='flex flex-wrap gap-2 mb-4'>
    <button class='range bg-gray-700 px-3 py-1 rounded' data-r='7'>7 jours</button>
    <button class='range bg-gray-700 px-3 py-1 rounded' data-r='30'>30 jours</button>
    <button class='range bg-gray-700 px-3 py-1 rounded' data-r='90'>90 jours</button>
    <button class='range bg-gray-700 px-3 py-1 rounded' data-r='m'>Mensuel</button>
  </div>
  <canvas id='statsChart' class='w-full mb-6'></canvas>
  <div id='stats'></div>`;
  document.querySelectorAll('.range').forEach(b=>b.onclick=e=>renderRange(e.target.dataset.r));
  renderRange(currentRange);
}
function renderRange(r){
  currentRange=r;
  const dbData=loadData();
  const labels=[],values=[];
  if(r==='m'){
    const monthly={};
    for(const [d,v] of Object.entries(dbData)){const key=d.slice(0,7);monthly[key]=(monthly[key]||0)+v;}
    Object.keys(monthly).sort().slice(-12).forEach(k=>{labels.push(new Date(k+'-01').toLocaleDateString('fr-FR',{month:'short',year:'2-digit'}));values.push(monthly[k]);});
  }else{
    const n=parseInt(r,10);
    for(let i=n-1;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const key=d.toISOString().slice(0,10);labels.push(d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric'}));values.push(dbData[key]||0);} }
  const ctx=document.getElementById('statsChart').getContext('2d');
  chartInstance&&chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'bar',data:{labels,datasets:[{data:values}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#d1d5db'},grid:{display:false}},y:{beginAtZero:true,ticks:{color:'#d1d5db'},grid:{color:'#374151'}}}}});
  const list=document.getElementById('stats');list.innerHTML='';labels.forEach((l,i)=>{const div=document.createElement('div');div.className='flex justify-between border-b border-gray-700 py-2';div.innerHTML=`<span>${l}</span><span class='font-semibold text-emerald-400'>${values[i]}</span>`;list.appendChild(div);});
}
/***** 6. Data sync *****/
function addPoints(d,pts){
  const dbData=loadData();
  dbData[d]=(dbData[d]||0)+pts;
  saveData(dbData);
  remoteDocRef&&remoteDocRef.set(dbData).catch(console.error);
}
function startRealtimeSync(){
  remoteDocRef.onSnapshot(snap=>{
    if(!snap.exists())return;
    localStorage.setItem(LS_KEY,JSON.stringify(snap.data()));
    scoreEl.textContent=getDayTotal(todayStr());
    if(currentTab==='stats')renderRange(currentRange);
  });
}
/***** 7. Init after auth *****/
function initUI(){
  tabTasks.onclick=renderTasks;
  tabStats.onclick=renderStats;
  renderTasks();
}
// buttons refs created after DOM load
const tabTasks=document.getElementById('tabTasks');
const tabStats=document.getElementById('tabStats');

auth.signInAnonymously().then(cred=>{
  uid=cred.user.uid;
  remoteDocRef=db.collection('users').doc(uid);
  window.remoteDocRef=remoteDocRef;
  // load first data then init UI
  remoteDocRef.get().then(snap=>{
    if(snap.exists())localStorage.setItem(LS
