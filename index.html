<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Points Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#10b981" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Couleur immÃ©diate pour Ã©viter flash blanc -->
  <style>html{background:#101827}</style>

  <!-- Tailwind (sans defer) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Styles internes -->
  <style>
    @keyframes press{0%{transform:scale(1)}50%{transform:scale(.96)}100%{transform:scale(1)}}
    .btn-press{animation:press .15s ease-out forwards;}
    .prog{position:absolute;inset:0;width:0%;background:#10b98133;border-radius:0.75rem;}
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

<!-- ===== Header ===== -->
<header class="p-4 bg-gray-800 shadow flex justify-between items-center">
  <div class="text-lg font-bold">Score du jourÂ : <span id="dailyScore" class="text-emerald-400">0</span></div>
  <div class="flex items-center gap-2">
    <span id="todayLabel" class="text-sm text-gray-400"></span>
    <button id="resetBtn" class="px-3 py-1 rounded-lg bg-red-600 text-xs hover:bg-red-500">ResetÂ ðŸ”„</button>
  </div>
</header>

<!-- ===== Tabs ===== -->
<nav class="flex justify-center gap-4 my-3">
  <button id="tabTasks" class="px-4 py-2 rounded-lg bg-emerald-600 font-semibold">TÃ¢ches</button>
  <button id="tabStats" class="px-4 py-2 rounded-lg bg-gray-700 font-semibold">Statistiques</button>
</nav>

<main id="mainContent" class="flex-1 overflow-y-auto p-4"></main>
<footer class="text-center text-xs text-gray-500 py-2">Â©Â 2025Â â€“ LibertÃ©Â !</footer>

<!-- Toast + son -->
<div id="toast" class="hidden fixed bottom-4 inset-x-0 flex justify-center pointer-events-none">
  <span id="toastMsg" class="px-4 py-2 rounded-lg bg-gray-800 text-sm shadow-lg opacity-0 transition-opacity duration-300"></span>
</div>
<audio id="tapSnd" src="tap-soft.mp3" preload="auto"></audio>

<!-- Librairies JS (defer) -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<!-- ===== Code de lâ€™application ===== -->
<script defer>
/* ---------- Helpers ---------- */
const LS='dpt-db';
const today=()=>new Date().toISOString().slice(0,10);
const load=()=>JSON.parse(localStorage.getItem(LS)||'{}');
const save=d=>localStorage.setItem(LS,JSON.stringify(d));
const norm=o=>{for(const k in o)if(typeof o[k]==='number')o[k]={total:o[k],counts:{}};return o};

/* ---------- State ---------- */
let data=norm(load()), chart=null, range='7', curTab='tasks', remoteDoc=null;

/* ---------- DOM refs ---------- */
const scoreEl=document.getElementById('dailyScore'),
      labelEl=document.getElementById('todayLabel'),
      mainEl=document.getElementById('mainContent'),
      tabTasks=document.getElementById('tabTasks'),
      tabStats=document.getElementById('tabStats'),
      resetBtn=document.getElementById('resetBtn');

/* ---------- UI feedback ---------- */
function toast(msg){
  const wrap=document.getElementById('toast'),box=document.getElementById('toastMsg');
  box.textContent=msg;wrap.classList.remove('hidden');
  requestAnimationFrame(()=>box.classList.remove('opacity-0'));
  setTimeout(()=>{box.classList.add('opacity-0');setTimeout(()=>wrap.classList.add('hidden'),300);},1200);
}
const flash=b=>{b.classList.add('btn-press');setTimeout(()=>b.classList.remove('btn-press'),150);};

/* ---------- Task list ---------- */
const TASKS=[
  {id:1,name:"Boire un verre d'eau",pts:1,goal:6},
  {id:2,name:"Ã‰tirements matinaux", pts:2,goal:4},
  {id:3,name:"MÃ©ditationÂ 5Â min",    pts:3,goal:2},
  {id:4,name:"MarcheÂ 10Â min",       pts:2,goal:3},
  {id:5,name:"LectureÂ 10Â pages",    pts:4,goal:1}
];

/* ---------- State helpers ---------- */
function ensureToday(){
  if(!data[today()]){
    data[today()]={total:0,counts:{}};
    save(data);
  }
}

/* ---------- Tabs ---------- */
function setTab(t){
  curTab=t;
  tabTasks.className=`px-4 py-2 rounded-lg font-semibold ${t==='tasks'?'bg-emerald-600':'bg-gray-700'}`;
  tabStats.className=`px-4 py-2 rounded-lg font-semibold ${t==='stats'?'bg-emerald-600':'bg-gray-700'}`;
}

/* ---------- Render TASKS ---------- */
function renderTasks(){
  ensureToday();
  const d=today();
  setTab('tasks');
  scoreEl.textContent=data[d].total;
  labelEl.textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'short'});
  const counts=data[d].counts;
  mainEl.innerHTML='';

  TASKS.forEach(t=>{
    const done=counts[t.id]||0,pct=Math.min(done/t.goal,1)*100;
    const btn=document.createElement('button');
    btn.className='relative w-full mb-3 px-4 py-3 rounded-xl bg-gray-800 active:bg-emerald-700 transition duration-150 shadow overflow-hidden';
    btn.innerHTML=`
      <div class="prog" style="width:${pct}%"></div>
      <div class="relative z-10 flex justify-between items-center">
        <span>${t.name}</span><span class="font-semibold">+${t.pts}</span>
      </div>
      <div class="relative z-10 text-xs text-gray-400 flex justify-end mt-1">
        <span data-c="${t.id}">${done}</span>/<span>${t.goal}</span>
      </div>`;
    btn.onclick=()=>clickTask(t,btn);
    mainEl.appendChild(btn);
  });
}
function clickTask(task,btn){
  ensureToday();
  const d=today();
  data[d].total+=task.pts;
  data[d].counts[task.id]=(data[d].counts[task.id]||0)+1;
  save(data);
  remoteDoc&&remoteDoc.set(data).catch(console.error);

  scoreEl.textContent=data[d].total;
  const done=data[d].counts[task.id];
  btn.querySelector(`[data-c='${task.id}']`).textContent=done;
  btn.querySelector('.prog').style.width=Math.min(done/task.goal,1)*100+'%';

  flash(btn); toast(`+${task.pts}Â pts âœ…`);
  const snd=document.getElementById('tapSnd'); if(snd){snd.currentTime=0;snd.play().catch(()=>{});}
}

/* ---------- Render STATS ---------- */
function renderStats(){
  setTab('stats');
  labelEl.textContent='';
  mainEl.innerHTML=`
    <div class='flex flex-wrap gap-2 mb-4'>
      <button class='r bg-gray-700 px-3 py-1 rounded' data-r='7'>7Â jours</button>
      <button class='r bg-gray-700 px-3 py-1 rounded' data-r='30'>30Â jours</button>
      <button class='r bg-gray-700 px-3 py-1 rounded' data-r='90'>90Â jours</button>
      <button class='r bg-gray-700 px-3 py-1 rounded' data-r='m'>Mensuel</button>
    </div>
    <canvas id='chart' class='w-full mb-6'></canvas>
    <div id='list'></div>`;
  document.querySelectorAll('.r').forEach(b=>b.onclick=e=>renderRange(e.target.dataset.r));
  renderRange(range);
}
function renderRange(r){
  range=r;
  const db=norm(load()), lab=[], val=[];
  if(r==='m'){
    const mon={};
    for(const [d,v] of Object.entries(db)) mon[d.slice(0,7)]=(mon[d.slice(0,7)]||0)+v.total;
    const base=new Date(); base.setDate(1);
    for(let i=11;i>=0;i--){
      const d=new Date(base); d.setMonth(d.getMonth()-i);
      const k=d.toISOString().slice(0,7);
      lab.push(d.toLocaleDateString('fr-FR',{month:'short',year:'2-digit'}));
      val.push(mon[k]||0);
    }
  }else{
    const n=parseInt(r);
    for(let i=n-1;i>=0;i--){
      const d=new Date(); d.setDate(d.getDate()-i);
      const k=d.toISOString().slice(0,10);
      lab.push(d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric'}));
      val.push(db[k]?.total||0);
    }
  }

  const ctx=document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels:lab,datasets:[{data:val}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#d1d5db'},grid:{display:false}},y:{beginAtZero:true,ticks:{color:'#d1d5db'},grid:{color:'#374151'}}}}});

  const list=document.getElementById('list'); list.innerHTML='';
  for(let i=lab.length-1;i>=0;i--){
    const row=document.createElement('div');
    row.className='flex justify-between border-b border-gray-700 py-2';
    row.innerHTML=`<span>${lab[i]}</span><span class='font-semibold text-emerald-400'>${val[i]}</span>`;
    list.appendChild(row);
  }
}

/* ---------- Reset & realtime ---------- */
function.resetDay(){
  ensureToday();
  const d=today();
  data[d]={total:0,counts:{}};
  save(data);
  remoteDoc&&remoteDoc.set(data).catch(console.error);
  toast('Score remis Ã Â 0');
  renderTasks();
}
function realtime(){
  remoteDoc.onSnapshot(s=>{
    if(!s.exists)return;
    Object.assign(data,norm(s.data())); save(data);
    if(curTab==='tasks') renderTasks();
    if(curTab==='stats') renderRange(range);
    scoreEl.textContent=data[today()]?.total||0;
  });
}

/* ---------- Rollover minuit ---------- */
function msToMidnight(){ const n=new Date();const m=new Date(n);m.setHours(24,0,0,0);return m-n;}
function scheduleMidnight(){ setTimeout(()=>{ensureToday(); if(curTab==='tasks')renderTasks(); scheduleMidnight();}, msToMidnight()+150); }

/* ---------- Init ---------- */
window.addEventListener('load',()=>{
  /* Firebase */
  firebase.initializeApp({
    apiKey:\"AIzaSyCssm-z4wtOWcK1qvbJc2SIQ6Pvc3JEszY\",
    authDomain:\"health-fdf5b.firebaseapp.com\",
    projectId:\"health-fdf5b\"});
  firebase.auth().signInAnonymously().then(()=>{
    remoteDoc=firebase.firestore().collection('users').doc('global');
    remoteDoc.get().then(snap=>{ if(snap.exists){Object.assign(data,norm(snap.data())); save(data);} initUI(); realtime(); });
  });
  /* SW */
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(console.error); }
});

function initUI(){
  tabTasks.onclick=renderTasks;
  tabStats.onclick=renderStats;
  resetBtn.onclick=resetDay;
  renderTasks();
  scheduleMidnight();
}
</script>
</body>
</html>
