<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Points TrackerÂ v2</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- Animation bouton -->
  <style>
    @keyframes press{0%{transform:scale(1)}50%{transform:scale(.96)}100%{transform:scale(1)}}
    .btn-press{animation:press .15s ease-out forwards;}
  </style>

  <link rel="manifest" href="manifest.webmanifest" />
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

  <!-- ===== Header ===== -->
  <header class="p-4 bg-gray-800 shadow flex items-center justify-between">
    <div class="text-lg font-bold">Score du jourÂ : <span id="dailyScore" class="text-emerald-400">0</span></div>
    <div class="flex items-center gap-2">
      <span id="todayLabel" class="text-sm text-gray-400"></span>
      <button id="resetBtn" class="px-3 py-1 rounded-lg bg-red-600 text-xs hover:bg-red-500">ResetÂ ðŸ”„</button>
    </div>
  </header>

  <!-- ===== Tabs ===== -->
  <nav class="flex justify-center gap-4 my-3">
    <button id="tabTasks" class="px-4 py-2 rounded-lg bg-emerald-600 font-semibold">TÃ¢ches</button>
    <button id="tabStats" class="px-4 py-2 rounded-lg bg-gray-700 font-semibold">Statistiques</button>
  </nav>

  <main id="mainContent" class="flex-1 overflow-y-auto p-4"></main>
  <footer class="text-center text-xs text-gray-500 py-2">Â©Â 2025 â€“ LibertÃ©Â !</footer>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-4 inset-x-0 flex justify-center pointer-events-none">
    <span id="toastMsg" class="px-4 py-2 rounded-lg bg-gray-800 text-sm shadow-lg opacity-0 transition-opacity duration-300"></span>
  </div>

  <!-- Click sound -->
  <audio id="tapSnd" src="tap-soft.mp3" preload="auto"></audio>

<script>
/* === Firebase === */
firebase.initializeApp({
  apiKey: "AIzaSyCssm-z4wtOWcK1qvbJc2SIQ6Pvc3JEszY",
  authDomain: "health-fdf5b.firebaseapp.com",
  projectId: "health-fdf5b"
});
const auth=firebase.auth(), db=firebase.firestore();
let remoteDocRef;

/* === Helpers === */
const LS='dpt-db';                               // on garde la clÃ© dâ€™origine
const today=()=>new Date().toISOString().slice(0,10);
const load=()=>JSON.parse(localStorage.getItem(LS)||'{}');
const save=d=>localStorage.setItem(LS,JSON.stringify(d));
function normalize(obj){                         // upgrade ancien format
  for(const k in obj){
    if(typeof obj[k]==='number') obj[k]={total:obj[k],counts:{}};
  }
  return obj;
}
const data=normalize(load());
save(data);

/* === Toast === */
function toast(msg){
  const box=document.getElementById('toastMsg'), wrap=document.getElementById('toast');
  box.textContent=msg; wrap.classList.remove('hidden'); requestAnimationFrame(()=>box.classList.remove('opacity-0'));
  setTimeout(()=>{box.classList.add('opacity-0'); setTimeout(()=>wrap.classList.add('hidden'),300);},1200);
}

/* === Button flash === */
function flash(btn){ btn.classList.add('btn-press'); setTimeout(()=>btn.classList.remove('btn-press'),150); }

/* === Task definitions (pts + objectif) === */
const TASKS=[
  {id:1,name:"Boire un verre d'eau",  pts:1,goal:6},
  {id:2,name:"Ã‰tirements matinaux",   pts:1,goal:4},
  {id:3,name:"MÃ©ditationÂ 5Â min",      pts:1,goal:2},
  {id:4,name:"MarcheÂ 10Â min",         pts:1,goal:3},
  {id:5,name:"LectureÂ 10Â pages",      pts:1,goal:1}
];

/* === UI refs === */
const scoreEl=document.getElementById('dailyScore');
const labelEl=document.getElementById('todayLabel');
const main=document.getElementById('mainContent');
const tabT=document.getElementById('tabTasks');
const tabS=document.getElementById('tabStats');
const reset=document.getElementById('resetBtn');
const snd=document.getElementById('tapSnd');
let chart=null, curTab='tasks', range='7';

/* === Renderers === */
function setTab(tab){
  curTab=tab;
  tabT.classList.toggle('bg-emerald-600',tab==='tasks');
  tabT.classList.toggle('bg-gray-700',tab!=='tasks');
  tabS.classList.toggle('bg-emerald-600',tab==='stats');
  tabS.classList.toggle('bg-gray-700',tab!=='stats');
}

function renderTasks(){
  setTab('tasks');
  const d=today(); scoreEl.textContent=data[d]?.total||0;
  labelEl.textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'short'});
  const counts=data[d]?.counts||{};
  main.innerHTML='';
  TASKS.forEach(t=>{
    const done=counts[t.id]||0, pct=Math.min(done/t.goal,1)*100;
    /* wrapper */
    const wrap=document.createElement('div'); wrap.className='relative w-full mb-3';
    /* progress bar */
    const bar=document.createElement('div'); bar.className='absolute inset-0 rounded-xl bg-emerald-700 opacity-40'; bar.style.width=pct+'%';
    /* button */
    const btn=document.createElement('button');
    btn.className='relative z-10 w-full px-4 py-3 rounded-xl bg-gray-800 active:bg-emerald-700 transition-colors duration-150 shadow text-left';
    btn.innerHTML=`${t.name}<span class='float-right font-semibold'>+${t.pts}</span>`;
    btn.onclick=()=>{
      addPoints(d,t);
      const newDone=(data[d].counts[t.id]||0);
      bar.style.width=Math.min(newDone/t.goal,1)*100+'%';
      if(snd){snd.currentTime=0; snd.play().catch(()=>{});}
      toast(`+${t.pts}Â ptsÂ âœ…`); flash(btn);
    };
    wrap.appendChild(bar); wrap.appendChild(btn); main.appendChild(wrap);
  });
}

function renderStats(){
  setTab('stats'); labelEl.textContent='';
  main.innerHTML=`<div class='flex flex-wrap gap-2 mb-4'>
    <button class='r bg-gray-700 px-3 py-1 rounded' data-r='7'>7Â jours</button>
    <button class='r bg-gray-700 px-3 py-1 rounded' data-r='30'>30Â jours</button>
    <button class='r bg-gray-700 px-3 py-1 rounded' data-r='90'>90Â jours</button>
    <button class='r bg-gray-700 px-3 py-1 rounded' data-r='m'>Mensuel</button>
  </div>
  <canvas id='statChart' class='w-full mb-6'></canvas>
  <div id='statList'></div>`;
  document.querySelectorAll('.r').forEach(b=>b.onclick=e=>renderRange(e.target.dataset.r));
  renderRange(range);
}

function renderRange(r){
  range=r;
  const labels=[], values=[], db=load(); normalize(db);
  if(r==='m'){
    const monthly={}; for(const [d,v] of Object.entries(db)){ monthly[d.slice(0,7)]=(monthly[d.slice(0,7)]||0)+v.total; }
    const base=new Date(); base.setDate(1);
    for(let i=11;i>=0;i--){ const d=new Date(base); d.setMonth(d.getMonth()-i); const key=d.toISOString().slice(0,7);
      labels.push(d.toLocaleDateString('fr-FR',{month:'short',year:'2-digit'})); values.push(monthly[key]||0);}
  }else{
    const n=parseInt(r); for(let i=n-1;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const k=d.toISOString().slice(0,10);
      labels.push(d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric'})); values.push(db[k]?.total||0);}
  }
  /* graph */
  const ctx=document.getElementById('statChart').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{data:values}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#d1d5db'},grid:{display:false}},y:{beginAtZero:true,ticks:{color:'#d1d5db'},grid:{color:'#374151'}}}}});
  /* list (newest first) */
  const list=document.getElementById('statList'); list.innerHTML='';
  for(let i=labels.length-1;i>=0;i--){ const row=document.createElement('div'); row.className='flex justify-between border-b border-gray-700 py-2';
    row.innerHTML=`<span>${labels[i]}</span><span class='font-semibold text-emerald-400'>${values[i]}</span>`; list.appendChild(row);}
}

/* === data & sync === */
function addPoints(d,task){
  if(!data[d]) data[d]={total:0,counts:{}}; const rec=data[d];
  rec.total+=task.pts; rec.counts[task.id]=(rec.counts[task.id]||0)+1; save(data);
  remoteDocRef&&remoteDocRef.set(data).catch(console.error);
  scoreEl.textContent=rec.total;
}
function resetDay(){
  const d=today(); data[d]={total:0,counts:{}}; save(data); remoteDocRef&&remoteDocRef.set(data).catch(console.error);
  toast('Score remis Ã Â 0'); renderTasks();
}
function realtime(){
  remoteDocRef.onSnapshot(snap=>{
    if(!snap.exists) return; Object.assign(data,normalize(snap.data())); save(data);
    if(curTab==='tasks') renderTasks(); else if(curTab==='stats') renderRange(range);
    scoreEl.textContent=data[today()]?.total||0;
  });
}

/* === init === */
function init(){ tabT.onclick=renderTasks; tabS.onclick=renderStats; reset.onclick=resetDay; renderTasks(); }
auth.signInAnonymously().then(()=>{
  remoteDocRef=db.collection('users').doc('global');
  remoteDocRef.get().then(snap=>{ if(snap.exists) {Object.assign(data,normalize(snap.data())); save(data);} init(); realtime(); });
}).catch(console.error);

/* PWA offline */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw-v2.js').catch(console.error); }
</script>
</body>
</html>
