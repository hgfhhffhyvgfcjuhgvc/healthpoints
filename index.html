<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Points Tracker v2</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- CSS animation press -->
  <style>
    @keyframes press{0%{transform:scale(1)}50%{transform:scale(.96)}100%{transform:scale(1)}}
    .btn-press{animation:press .15s ease-out forwards;}
  </style>

  <link rel="manifest" href="manifest.webmanifest" />
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="p-4 bg-gray-800 shadow flex items-center justify-between">
    <div class="text-lg font-bold">Score du jourÂ : <span id="dailyScore" class="text-emerald-400">0</span></div>
    <div class="flex items-center gap-2">
      <span id="todayLabel" class="text-sm text-gray-400"></span>
      <button id="resetBtn" class="px-3 py-1 rounded-lg bg-red-600 text-xs hover:bg-red-500">ResetÂ ðŸ”„</button>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="flex justify-center gap-4 my-3">
    <button id="tabTasks" class="px-4 py-2 rounded-lg bg-emerald-600 font-semibold">TÃ¢ches</button>
    <button id="tabStats" class="px-4 py-2 rounded-lg bg-gray-700 font-semibold">Statistiques</button>
  </nav>

  <main id="mainContent" class="flex-1 overflow-y-auto p-4"></main>
  <footer class="text-center text-xs text-gray-500 py-2">Â©â€¯2025Â â€“ LibertÃ©Â !</footer>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-4 inset-x-0 flex justify-center pointer-events-none">
    <span id="toastMsg" class="px-4 py-2 rounded-lg bg-gray-800 text-sm shadow-lg opacity-0 transition-opacity duration-300"></span>
  </div>

  <!-- Click sound -->
  <audio id="tapSnd" src="tap-soft.mp3" preload="auto"></audio>

<script>
/***** Firebase *****/
firebase.initializeApp({ apiKey:"AIzaSyCssm-z4wtOWcK1qvbJc2SIQ6Pvc3JEszY", authDomain:"health-fdf5b.firebaseapp.com", projectId:"health-fdf5b" });
const auth=firebase.auth(); const db=firebase.firestore();
let remoteDocRef;

/***** Helpers *****/
const LS='dpt2-db';
const today=()=>new Date().toISOString().slice(0,10);
const load=()=>JSON.parse(localStorage.getItem(LS)||'{}');
const save=d=>localStorage.setItem(LS,JSON.stringify(d));
const ensureDay=o=>{ if(typeof o==='number') return {total:o,counts:{}}; return o; };
const getTotals=()=>{ const d=load(); Object.keys(d).forEach(k=>d[k]=ensureDay(d[k])); return d; };
const dayTotal=d=>{ const rec=getTotals()[d]; return rec?rec.total:0; };

/***** Toast *****/
function toast(msg){ const t=document.getElementById('toast'),m=document.getElementById('toastMsg');m.textContent=msg; t.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.remove('opacity-0')); setTimeout(()=>{m.classList.add('opacity-0'); setTimeout(()=>t.classList.add('hidden'),300);},1200);}  

/***** btn flash *****/
function flash(btn){ btn.classList.add('btn-press'); setTimeout(()=>btn.classList.remove('btn-press'),150); }

/***** Task config avec objectifs *****/
const TASKS=[
  {id:1,name:"Boire un verre d'eau",pts:1,goal:6},
  {id:2,name:"Ã‰tirements matinaux",pts:2,goal:4},
  {id:3,name:"MÃ©ditationÂ 5Â min",pts:3,goal:2},
  {id:4,name:"MarcheÂ 10Â min",pts:2,goal:3},
  {id:5,name:"LectureÂ 10Â pages",pts:4,goal:1}
];

/***** UI refs *****/
const scoreEl=document.getElementById('dailyScore');
const labelEl=document.getElementById('todayLabel');
const main=document.getElementById('mainContent');
const tabT=document.getElementById('tabTasks');
const tabS=document.getElementById('tabStats');
const resetBtn=document.getElementById('resetBtn');
const snd=document.getElementById('tapSnd');
let chart=null, curTab='tasks', range='7';

/***** Renderers *****/
function active(tab){ curTab=tab; tabT.classList.toggle('bg-emerald-600',tab==='tasks');tabT.classList.toggle('bg-gray-700',tab!=='tasks'); tabS.classList.toggle('bg-emerald-600',tab==='stats');tabS.classList.toggle('bg-gray-700',tab!=='stats'); }

function renderTasks(){
  active('tasks'); const d=today(); scoreEl.textContent=dayTotal(d); labelEl.textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'short'});
  const data=getTotals(); const counts=(data[d]?data[d].counts:{});
  main.innerHTML='';
  TASKS.forEach(t=>{
    const done=counts[t.id]||0; const pct=Math.min(done/t.goal,1)*100;
    const wrap=document.createElement('div'); wrap.className='relative w-full mb-3';
    const btn=document.createElement('button'); btn.className='relative z-10 w-full px-4 py-3 rounded-xl bg-gray-800 active:bg-emerald-700 transition-colors duration-150 shadow text-left';
    btn.innerHTML=`${t.name}<span class='float-right font-semibold'>+${t.pts}</span>`;
    const bar=document.createElement('div'); bar.className='absolute top-0 left-0 h-full rounded-xl bg-emerald-700 opacity-40'; bar.style.width=pct+'%';
    btn.onclick=()=>{ addPts(d,t); updateBtn(t.id); };
    wrap.appendChild(btn); wrap.appendChild(bar); main.appendChild(wrap);
    // store elements for update
    btn.dataset.barId=t.id; bar.dataset.barId=t.id;
  });
}
function updateBtn(taskId){ const d=today(); const data=getTotals(); const counts=data[d].counts||{}; const done=counts[taskId]||0; const task=TASKS.find(x=>x.id==taskId); const pct=Math.min(done/task.goal,1)*100; document.querySelectorAll(`[data-bar-id='${taskId}']`).forEach(el=>{ if(el.tagName==='DIV') el.style.width=pct+'%'; }); }

function renderStats(){ /* identique aux versions prÃ©cÃ©dentes (non modifiÃ©) */ }
function renderRange(r){ /* identique */ }

/***** Sync *****/
function addPts(date,task){ const data=getTotals(); if(!data[date]) data[date]={total:0,counts:{}}; const rec=data[date]; rec.total+=task.pts; rec.counts[task.id]=(rec.counts[task.id]||0)+1; save(data); remoteDocRef&&remoteDocRef.set(data).catch(console.error); scoreEl.textContent=rec.total; toast(`+${task.pts}Â ptsÂ âœ…`); flash(event.currentTarget); if(snd){ snd.currentTime=0; snd.play().catch(()=>{});} }
function resetDay(){ const d=today(); const data=getTotals(); data[d]={total:0,counts:{}}; save(data); remoteDocRef&&remoteDocRef.set(data).catch(console.error); scoreEl.textContent='0'; renderTasks(); toast('Score remis Ã Â 0'); }
function realtime(){ remoteDocRef.onSnapshot(s=>{ if(!s.exists) return; const cloud=s.data(); save(cloud); if(curTab==='tasks') renderTasks(); else { scoreEl.textContent=dayTotal(today()); if(curTab==='stats') renderRange(range);} }); }

/***** Init *****/
function init(){ tabT.onclick=renderTasks; tabS.onclick=renderStats; resetBtn.onclick=resetDay; renderTasks(); }

auth.signInAnonymously().then(()=>{ remoteDocRef=db.collection('users').doc('global'); remoteDocRef.get().then(s=>{ if(s.exists) save(s.data()); init(); realtime(); }).catch(e=>{console.error(e); init();}); }).catch(console.error);

/***** SW *****/
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw-v2.js').catch(console.error); }
</script>
</body>
</html>
